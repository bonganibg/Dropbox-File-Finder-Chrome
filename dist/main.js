/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";let e,t,n,o,l,a={counter:void 0,min:void 0,lastSavedTime:void 0,foundTaskName:void 0,StudentName:"",sharedStudentNum:"",routeList:void 0,reviewCount:0,inc:0,combinedTime:0,removeSpinner:!1,hashParams:null,rootPath:"",fileName:"",foundFiles:!1,storeToken:""},r="",i=0,s=0,c=0,d=!1;const m=new class{constructor(e,t,n,o){this.clientId=e,this.clientSecret=t,this.redirectUrl=n,this.shared_variables=o}createDbxConnection(){let e=localStorage.getItem("access_token");"null"===e&&(this.shared_variables.hashParams=new URLSearchParams(window.location.hash.substr(1)),this.shared_variables.accessToken=this.shared_variables.hashParams.get("access_token"),localStorage.setItem("access_token",e));let t=new Dropbox.Dropbox({clientId:this.clientId,clientSecret:this.clientSecret,accessToken:e});this.shared_variables.dbx=t}}("gsw6a2m0r2u44lt","nwpi7lk0yyp2v44","https://hyperiondev.cogrammar.com/reviewer/dashboard/",a);m.createDbxConnection();let u,p=a.dbx;function h(){console.log("%c Extracting St Name","color: red");const e=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student:"))),t=e[0]?.textContent?.split(":")[1]?.trim();return t}async function g(e,t){let n=t;n.match(/build your brand/i)&&/(01|02|03|04|05)/.test(n)&&(n=function(e){const t={I:"01",II:"02",III:"03",IV:"04",V:"05",VI:"06"};return e.replace(/\b(I|II|III|IV|V|VI)\b/g,((e,n)=>t[n]||e))}(n).toLowerCase()),console.log("query",n),console.log(`%c Searching for files ${s}`,"color: #5390d9");const o=s>0?e+` (${s})`:e;await p.filesSearchV2({query:n,options:{path:"/"+o,max_results:5}}).then((function(o){d&&(l.innerHTML="",d=!1),console.log(`%c  making request: ${s}`,"color: orange"),s++;let a=o.result.matches;if(s>=4)!function(e){document.querySelectorAll(".DBXFF-foundRes").forEach((t=>{let n=t.textContent?.toLowerCase()?.trim(),o=e.split(" ");taskNum.split(" ").forEach((e=>{if(e.length>0&&n.includes(e.toLowerCase())){let n=t.innerHTML.replace(new RegExp(e,"gi"),`<b style="font-weight: 100; color: #FFC107">${e}</b>`);t.innerHTML=n}})),o.forEach((e=>{if(e.length>2&&n.includes(e.toLowerCase())){let n=t.innerHTML.replace(new RegExp(e,"gi"),`<b class="highlight">${e}</b>`);t.innerHTML=n}}))}))}(n);else{if(console.log(`%c results found: ${a.length}`,"color: #2196f3"),a.forEach(((e,t)=>{let n=e.metadata.metadata.path_display;if(console.log("taskNum",taskNum),n.includes(taskNum)){taskNum<10&&(taskNum="T0"+taskNum[taskNum.length-1]);let t=document.createElement("div");t.className="DBXFF-btnAndListContainer";let n=document.createElement("div");n.className="DBXFF-foundRes",n.textContent=e.metadata.metadata.path_display;let o=document.createElement("div");o.className="DBXFF-dlIconContainer";let a=document.createElement("img"),r=document.createElement("img");r.title="Open Task Folder in dropbox",r.src=chrome.runtime.getURL("images/externalLink.png"),r.addEventListener("click",(async t=>{let n=e.metadata.metadata.path_display,o=n.lastIndexOf("/"),l="https://www.dropbox.com/work/HyperionDev%20Reviewers"+n.substring(0,o).replace(" ","%20");window.open(l,"_blank")})),document.createElement("img").alt=e.metadata.metadata.name,a.src=chrome.runtime.getURL("images/dlFOlder.png"),a.alt="dl-icon",a.className="DBXFF-dl-icon-list",a.title="Download Task folder",a.addEventListener("click",(async t=>{t.stopPropagation(),a.classList.add("rotate-center"),a.src=chrome.runtime.getURL("images/loader.png"),function(e,t){console.log("%c  creating Download Folder path","color: red");let n=!1;if(e.path_display.endsWith(".pdf")&&(n=!0),n){const n=e.path_display.lastIndexOf("/");f(e.path_display.substring(0,n),t)}else f(e.path_display,t)}(e.metadata.metadata,a)})),o.appendChild(a),t.appendChild(o),t.appendChild(r),t.appendChild(n),l.appendChild(t)}})),s>=4)return;g(e,t)}})).catch((function(e){console.log(e),d&&(l.innerHTML="\n        <p>Either the token has expired. A popup will appear. (If not - Refresh Browser)</p>\n        <br>\n        <p>Or the Task Name could no be found inside student folders</p>\n        <br>\n        <p>Or CoGrammar API is offline</p>\n        <br>\n        <p>Or you have an internet connection issue</p>\n        <br>\n        <p>Try looking up the student number in Dropbox</p>\n        ",d=!1),console.log("%c Search ended","color: hotpink"),async function(e){console.log("%c Checking token","color: #f078c0"),console.log("removeSpinner",d);try{await e.usersGetCurrentAccount(),console.log("%c Access token is still valid","color: #7cb518"),alert("Access token is still valid ✔")}catch(e){console.log("removeSpinner",d),d&&(l.innerHTML="Token Expired",d=!1);let t=confirm('Tokens only last 4 hour. This token might have expired ❌. Proceeding to "Auth" to get a new one.');console.log("%c Access token expired or is invalid","color: #f94144"),t&&(localStorage.setItem("access_token",null),function(){console.log("%c Auth2Flow","color: red"),history.replaceState({},document.title,window.location.href.split("#")[0]);const e="https://www.dropbox.com/oauth2/authorize?response_type=token&client_id="+dropboxClientId+"&redirect_uri="+encodeURIComponent(redirectHomeUrl);window.location.href=e}())}}(p)}))}async function f(e,t){await p.filesDownloadZip({path:e}).then((function(t){!function(e,t){const n=window.URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=studentName+"_"+t,document.body.appendChild(o),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(new Blob([t.result.fileBlob],{type:"application/zip"}),e.substring(e.lastIndexOf("/")+1))})).catch((function(e){console.log(e),alert("Error downloading file. Download folder could be containing more than 100 files")})),t.classList.remove("rotate-center"),t.src=chrome.runtime.getURL("images/dlFOlder.png")}async function v(){if(window.location.pathname.includes("generate_review")){async function l(){"visible"===document.visibilityState?(clearInterval(u),u=setInterval((()=>w()),1e3),await v(),document.removeEventListener("visibilitychange",l)):clearInterval(u)}document.addEventListener("visibilitychange",l)}else clearInterval(u);e=parseInt(localStorage.getItem("counter"))||0,t=parseInt(localStorage.getItem("minutes"))||0,n=parseInt(localStorage.getItem("lastSavedTime"))||(new Date).getTime(),e+=Math.floor(((new Date).getTime()-n)/1e3),window.addEventListener("beforeunload",(async()=>{E(),clearInterval(u)}));let o=document.querySelectorAll("a");o?.forEach((n=>{n?.textContent.includes("Return to dashboard")&&n.addEventListener("click",(()=>{e=0,t=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),localStorage.setItem("lastSavedTime",null),clearInterval(u),"false"==localStorage.getItem("rememberReview")&&(localStorage.setItem("id_improve_comments",""),localStorage.setItem("id_positive_comments",""),localStorage.setItem("id_overall_comments",""))}))}))}function w(){e++,e>59&&(t+=Math.floor(e/60),e%=60),t<5?(counterEl.style.color="#8BC34A",counterEl.style.animationDuration="10s"):t<7?(counterEl.style.color="#ffeb3b",counterEl.style.animationDuration="5s"):t<11?(counterEl.style.color="#ff9800",counterEl.style.animationDuration="2s"):t<13?(counterEl.style.color="#ff5722",counterEl.style.animationDuration="1s"):(counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s"),c=`${t>9?"":0}${t}:${e>9?"":0}${e}`,t>60&&(counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s ",c="59:00",clearInterval(u)),counterEl.textContent=c,E()}function E(){localStorage.setItem("counter",e),localStorage.setItem("minutes",t),localStorage.setItem("lastSavedTime",(new Date).getTime())}(window.location.pathname.includes("generate_review")||window.location.pathname.includes("generate_dfe_review"))&&(function(){console.log("%c Creating UI","color: red"),document.createElement("span").className="result_loader",l=document.createElement("div"),l.className="DBXFF-query-results",l.innerHTML='<span class="result_loader"></span>';const e=document.createElement("div");e.className="DBXFF-main-input-container",floatingElement.className="DBXFF-box-layout DBXFF-slide-in-left",floatingElement.style.backgroundImage=`url(${chrome.runtime.getURL("./images/nav-bg.gif")})`;let t=document.createElement("div");t.className="DBXFF-slide-btn ",t.textContent="Hide";let n=!1;t.addEventListener("click",(()=>{floatingElement.classList.toggle("DBXFF-slide-out-left"),t.classList.toggle("toggleBtn"),n=!n,n?(t.textContent="Show",timerContainer.classList.add("DBXFF-timer-container-fixed","fade-in")):(t.textContent="Hide",timerContainer.classList.remove("DBXFF-timer-container-fixed","fade-in"))})),studentNumberEl.id="DBXFF-mystudentNumberEl",taskNameEl.id="DBXFF-mytaskNameEl",floatingElement.prepend(t),studentNameEl.textContent=h(),reviewDetailsEl.appendChild(studentNameEl),studentNumberContainerEl.appendChild(lookUpStudentBtn),studentNumberContainerEl.appendChild(studentNumberEl),reviewDetailsEl.appendChild(studentNumberContainerEl),reviewDetailsEl.appendChild(taskNameEl),e.appendChild(reviewDetailsEl),e.appendChild(l),floatingElement.appendChild(e),document.body.appendChild(floatingElement),function(){console.log("%c Extracting St Number","color: red");const e=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student number"))),t=e[0]?.textContent?.split(":")[1]?.trim();studentNumberEl.textContent=t,function(e){r=e,lookUpStudentBtn.addEventListener("click",(()=>{let t=`https://www.dropbox.com/search/work?path=%2F&query=${e}&search_token=mUrM54J2SiALJes%2B%2Boc65k3O8pz4DOlJOX9WlhH8KKI%3D&typeahead_session_id=09702658948404806500012995044766`;window.open(t,"_blank")})),console.log("%c Extracting Task Name","color: red");let t=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Task")));t.forEach((e=>{let t=/Task \d+/gi;t.test(e.textContent)&&(taskNum=e.textContent.match(t)[0].split(" ")[1],localStorage.setItem("taskNumber",`Task ${taskNum}`))})),t.forEach((t=>{const n=t?.textContent?.trim(),l=n.lastIndexOf("-")+1;if(0!==l&&(o=n?.substring(l)?.trim(),o.includes(":"))){const e=o.lastIndexOf(":")+1;o=o?.substring(e)?.trim()}taskNameEl.textContent=o,d=!0,g(e,o,taskNum)}))}(t),h()}(),function(){let e=localStorage.getItem("reviewCount");i=e||0;let t=document.createElement("div");t.className="DBXFF-counter-container";let n=document.createElement("p");n.className="DBXFF-review-count",n.textContent=`Reviews done: ${i}`;let o=document.createElement("img");o.src=chrome.runtime.getURL("images/reset.png"),o.alt="reviewReset",o.title="Reset",o.addEventListener("click",(()=>{confirm("Are you sure you want to reset the review count?")&&(i=0,localStorage.setItem("reviewCount",0),n.textContent="Reviews done: 0")})),t.prepend(o),t.prepend(n),floatingElement.prepend(t)}()}(),v(),u=setInterval((()=>w()),1e3)),timeResetIcon.addEventListener("click",(async()=>{console.log("%c timer reset","color: #ffba08"),clearInterval(u),e=0,t=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),c=0,u=setInterval((()=>w()),1e3),await v()})),reviewCompleteBtn?.addEventListener("click",(()=>{i++,localStorage.setItem("reviewCount",i),counterEl.style.color="#8BC34A",counterEl.style.animationDuration="3s"}))})();