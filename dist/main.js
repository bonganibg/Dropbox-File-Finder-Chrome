/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";const e={counter:void 0,min:void 0,lastSavedTime:void 0,foundTaskName:void 0,StudentName:"",sharedStudentNum:"",routeList:void 0,reviewCount:0,inc:0,combinedTime:0,removeSpinner:!1,hashParams:void 0,rootPath:"",fileName:"",foundFiles:!1,storeToken:"",taskNum:void 0,studentName:void 0},t=new class{constructor(e){this.shared=e}extractStudentNumber(e){console.log("%c Extracting St Number","color: red");const t=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student number"))),n=t[0]?.textContent?.split(":")[1]?.trim();studentNumberEl.textContent=n,this.extractTaskName(n,e),this.extractStudentName()}extractStudentName(){console.log("%c Extracting St Name","color: red");const e=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student:"))),t=e[0]?.textContent?.split(":")[1]?.trim();return t}extractTaskName(e,t){this.shared.sharedStudentNum=e,lookUpStudentBtn.addEventListener("click",(()=>{let t=`https://www.dropbox.com/search/work?path=%2F&query=${e}`;window.open(t,"_blank")})),console.log("%c Extracting Task Name","color: red");let n=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Task")));n.forEach((e=>{let t=/Task \d+/gi;t.test(e.textContent)&&(this.shared.taskNum=e.textContent.match(t)[0].split(" ")[1],console.log(this.shared.taskNum),localStorage.setItem("taskNumber",`Task ${this.shared.taskNum}`))})),n.forEach((n=>{const a=n?.textContent?.trim(),o=a.lastIndexOf("-")+1;if(0!==o&&(this.shared.foundTaskName=a?.substring(o)?.trim(),this.shared.foundTaskName.includes(":"))){const e=this.shared.foundTaskName.lastIndexOf(":")+1;this.shared.foundTaskName=this.shared.foundTaskName?.substring(e)?.trim()}taskNameEl.textContent=this.shared.foundTaskName,this.shared.removeSpinner=!0,t(e,this.shared.foundTaskName,this.shared.taskNum)}))}}(e),n=new class{constructor(e){this.shared=e}downloadFolder(e,t,n){console.log("%c  creating Download Folder path","color: red");let a=!1;if(e.path_display.endsWith(".pdf")&&(a=!0),a){const a=e.path_display.lastIndexOf("/"),o=e.path_display.substring(0,a);this.downloadFileBob(o,t,n)}else this.downloadFileBob(e.path_display,t,n)}async downloadFileBob(e,t,n){await n.filesDownloadZip({path:e}).then((function(t){const n=new Blob([t.result.fileBlob],{type:"application/zip"});this.getDLLink(n,e.substring(e.lastIndexOf("/")+1))})).catch((function(e){console.log(e),alert("Error downloading file. Download folder could be containing more than 100 files")})),t.classList.remove("rotate-center"),t.src=chrome.runtime.getURL("images/dlFOlder.png")}getDLLink(e,t){const n=window.URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=shared.StudentName+"_"+t,document.body.appendChild(a),document.body.appendChild(a),a.click(),document.body.removeChild(a)}}(e),a=new class{constructor(e){this.shared=e,this.startTimer=null}setUpTimer(e){(window.location.pathname.includes("generate_review")||window.location.pathname.includes("generate_dfe_review"))&&(e(),this.loadTimer(),this.startTimer=setInterval((()=>this.reviewTimer()),1e3)),timeResetIcon.addEventListener("click",(async()=>{console.log("%c timer reset","color: #ffba08"),clearInterval(this.startTimer),this.shared.counter=0,this.shared.min=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),this.shared.combinedTime=0,this.startTimer=setInterval((()=>this.reviewTimer()),1e3),await this.loadTimer()})),reviewCompleteBtn?.addEventListener("click",(()=>{this.shared.reviewCount++,localStorage.setItem("reviewCount",this.shared.reviewCount),counterEl.style.color="#8BC34A",counterEl.style.animationDuration="3s"}))}async loadTimer(){if(window.location.pathname.includes("generate_review")){async function t(){"visible"===document.visibilityState?(clearInterval(this.startTimer),this.startTimer=setInterval((()=>this.reviewTimer),1e3),document.removeEventListener("visibilitychange",t)):clearInterval(this.startTimer)}document.addEventListener("visibilitychange",t)}else clearInterval(this.startTimer);this.shared.counter=parseInt(localStorage.getItem("counter"))||0,this.shared.min=parseInt(localStorage.getItem("minutes"))||0,this.shared.lastSavedTime=parseInt(localStorage.getItem("lastSavedTime"))||(new Date).getTime(),this.shared.counter+=Math.floor(((new Date).getTime()-this.shared.lastSavedTime)/1e3),window.addEventListener("beforeunload",(async()=>{this.saveTimeValues(),clearInterval(this.startTimer)}));let e=document.querySelectorAll("a");e?.forEach((e=>{e?.textContent.includes("Return to dashboard")&&e.addEventListener("click",(()=>{this.shared.counter=0,this.shared.min=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),localStorage.setItem("lastSavedTime",null),clearInterval(this.startTimer),"false"==localStorage.getItem("rememberReview")&&(localStorage.setItem("id_improve_comments",""),localStorage.setItem("id_positive_comments",""),localStorage.setItem("id_overall_comments",""))}))}))}reviewTimer(){this.shared.counter++,this.shared.counter>59&&(this.shared.min+=Math.floor(this.shared.counter/60),this.shared.counter%=60),this.shared.min<5?(counterEl.style.color="#8BC34A",counterEl.style.animationDuration="10s"):this.shared.min<7?(counterEl.style.color="#ffeb3b",counterEl.style.animationDuration="5s"):this.shared.min<11?(counterEl.style.color="#ff9800",counterEl.style.animationDuration="2s"):this.shared.min<13?(counterEl.style.color="#ff5722",counterEl.style.animationDuration="1s"):(this.shared.min,counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s"),this.shared.combinedTime=`${this.shared.min>9?"":0}${this.shared.min}:${this.shared.counter>9?"":0}${this.shared.counter}`,this.shared.min>60&&(counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s ",this.shared.combinedTime="59:00",clearInterval(this.startTimer)),counterEl.textContent=this.shared.combinedTime,this.saveTimeValues()}saveTimeValues(){localStorage.setItem("counter",this.shared.counter),localStorage.setItem("minutes",this.shared.min),localStorage.setItem("lastSavedTime",(new Date).getTime())}}(e);let o=new class{constructor(e,t,n,a){this.clientId=e,this.clientSecret=t,this.redirectUrl=n,this.shared=a}createDbxConnection(){let e=localStorage.getItem("access_token");"null"===e&&(this.shared.hashParams=new URLSearchParams(window.location.hash.substr(1)),e=this.shared.hashParams.get("access_token"),localStorage.setItem("access_token",e));let t=new Dropbox.Dropbox({clientId:this.clientId,clientSecret:this.clientSecret,accessToken:e});return this.dbx=t,t}async checkToken(e){console.log("%c Checking token","color: #f078c0"),console.log("removeSpinner",this.shared.removeSpinner);try{await e.usersGetCurrentAccount(),console.log("%c Access token is still valid","color: #7cb518"),alert("Access token is still valid ✔")}catch(e){console.log("removeSpinner",this.shared.removeSpinner),this.shared.removeSpinner&&(this.shared.routeList.innerHTML="Token Expired",this.shared.removeSpinner=!1);let t=confirm('Tokens only last 4 hour. This token might have expired ❌. Proceeding to "Auth" to get a new one.');console.log("%c Access token expired or is invalid","color: #f94144"),t&&(localStorage.setItem("access_token",null),this.auth2Flow())}}auth2Flow(){console.log("%c Auth2Flow","color: red"),history.replaceState({},document.title,window.location.href.split("#")[0]);const e="https://www.dropbox.com/oauth2/authorize?response_type=token&client_id="+this.clientId+"&redirect_uri="+encodeURIComponent(this.redirectUrl);window.location.href=e}}("gsw6a2m0r2u44lt","nwpi7lk0yyp2v44","https://hyperiondev.cogrammar.com/reviewer/dashboard/",e);console.log(o);let s=o.createDbxConnection();function i(t){e.removeSpinner&&(e.routeList.innerHTML=t,e.removeSpinner=!1)}async function r(t,a){let l=function(e){return e.match(/build your brand/i)&&/(01|02|03|04|05)/.test(e)?function(e){const t={I:"01",II:"02",III:"03",IV:"04",V:"05",VI:"06"};return e.replace(/\b(I|II|III|IV|V|VI)\b/g,((e,n)=>t[n]||e))}(e).toLowerCase():e}(a),c=await async function(t,n){let a=t,o=e.inc;const i=e.inc>0?a+` (${o})`:a;try{let e=await s.filesSearchV2({query:n,options:{path:"/"+i,max_results:5}});return await e.result.matches}catch(e){console.log(e)}}(t,l);if(null==c)return i("\n      <p>Either the token has expired. A popup will appear. (If not - Refresh Browser)</p>\n      <br>\n      <p>Or the Task Name could no be found inside student folders</p>\n      <br>\n      <p>Or CoGrammar API is offline</p>\n      <br>\n      <p>Or you have an internet connection issue</p>\n      <br>\n      <p>Try looking up the student number in Dropbox</p>\n      "),void await o.checkToken(s);i(""),e.inc++,e.inc>=4?function(t){document.querySelectorAll(".DBXFF-foundRes").forEach((n=>{let a=n.textContent?.toLowerCase()?.trim(),o=t.split(" ");e.taskNum.split(" ").forEach((e=>{if(e.length>0&&a.includes(e.toLowerCase())){let t=n.innerHTML.replace(new RegExp(e,"gi"),`<b style="font-weight: 100; color: #FFC107">${e}</b>`);n.innerHTML=t}})),o.forEach((e=>{if(e.length>2&&a.includes(e.toLowerCase())){let t=n.innerHTML.replace(new RegExp(e,"gi"),`<b class="highlight">${e}</b>`);n.innerHTML=t}}))}))}(l):e.foundFiles||(c.forEach(((t,a)=>{t.metadata.metadata.path_display.includes(e.taskNum)&&(e.taskNum<10&&(e.taskNum="T0"+e.taskNum[e.taskNum.length-1]),function(t){let a=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),r=document.createElement("img"),l=document.createElement("img");a.className="DBXFF-btnAndListContainer",o.className="DBXFF-foundRes",o.textContent=t.metadata.metadata.path_display,i.className="DBXFF-dlIconContainer",l.title="Open Task Folder in dropbox",l.src=chrome.runtime.getURL("images/externalLink.png"),document.createElement("img").alt=t.metadata.metadata.name,r.src=chrome.runtime.getURL("images/dlFOlder.png"),r.alt="dl-icon",r.className="DBXFF-dl-icon-list",r.title="Download Task folder",i.appendChild(r),a.appendChild(i),a.appendChild(l),a.appendChild(o),e.routeList.appendChild(a),l.addEventListener("click",(async e=>{let n=t.metadata.metadata.path_display,a=n.lastIndexOf("/"),o="https://www.dropbox.com/work/HyperionDev%20Reviewers"+n.substring(0,a).replace(" ","%20");window.open(o,"_blank")})),r.addEventListener("click",(async e=>{e.stopPropagation(),r.classList.add("rotate-center"),r.src=chrome.runtime.getURL("images/loader.png"),n.downloadFolder(t.metadata.metadata,r,s)}))}(t))})),e.inc>=4||r(t,a))}a.setUpTimer((function(){console.log("%c Creating UI","color: red"),document.createElement("span").className="result_loader",e.routeList=document.createElement("div"),e.routeList.className="DBXFF-query-results",e.routeList.innerHTML='<span class="result_loader"></span>';const n=document.createElement("div");n.className="DBXFF-main-input-container",floatingElement.className="DBXFF-box-layout DBXFF-slide-in-left",floatingElement.style.backgroundImage=`url(${chrome.runtime.getURL("./images/nav-bg.gif")})`;let a=document.createElement("div");a.className="DBXFF-slide-btn ",a.textContent="Hide";let o=!1;a.addEventListener("click",(()=>{floatingElement.classList.toggle("DBXFF-slide-out-left"),a.classList.toggle("toggleBtn"),o=!o,o?(a.textContent="Show",timerContainer.classList.add("DBXFF-timer-container-fixed","fade-in")):(a.textContent="Hide",timerContainer.classList.remove("DBXFF-timer-container-fixed","fade-in"))})),studentNumberEl.id="DBXFF-mystudentNumberEl",taskNameEl.id="DBXFF-mytaskNameEl",floatingElement.prepend(a),studentNameEl.textContent=t.extractStudentName(),reviewDetailsEl.appendChild(studentNameEl),studentNumberContainerEl.appendChild(lookUpStudentBtn),studentNumberContainerEl.appendChild(studentNumberEl),reviewDetailsEl.appendChild(studentNumberContainerEl),reviewDetailsEl.appendChild(taskNameEl),n.appendChild(reviewDetailsEl),n.appendChild(e.routeList),floatingElement.appendChild(n),document.body.appendChild(floatingElement),t.extractStudentNumber(r),function(){let t=localStorage.getItem("reviewCount");e.reviewCount=t||0;let n=document.createElement("div");n.className="DBXFF-counter-container";let a=document.createElement("p");a.className="DBXFF-review-count",a.textContent=`Reviews done: ${e.reviewCount}`;let o=document.createElement("img");o.src=chrome.runtime.getURL("images/reset.png"),o.alt="reviewReset",o.title="Reset",o.addEventListener("click",(()=>{confirm("Are you sure you want to reset the review count?")&&(e.reviewCount=0,localStorage.setItem("reviewCount",0),a.textContent="Reviews done: 0")})),n.prepend(o),n.prepend(a),floatingElement.prepend(n)}()}))})();