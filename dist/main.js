/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";const e={counter:void 0,min:void 0,lastSavedTime:void 0,foundTaskName:void 0,StudentName:"",sharedStudentNum:"",routeList:void 0,reviewCount:0,inc:0,combinedTime:0,removeSpinner:!1,hashParams:void 0,rootPath:"",fileName:"",foundFiles:!1,storeToken:"",taskNum:void 0,studentName:void 0};let t=new class{constructor(e,t,n,o){this.clientId=e,this.clientSecret=t,this.redirectUrl=n,this.shared=o}createDbxConnection(){let e=localStorage.getItem("access_token");return"null"===e&&(this.shared.hashParams=new URLSearchParams(window.location.hash.substr(1)),e=this.shared.hashParams.get("access_token"),localStorage.setItem("access_token",e)),new Dropbox.Dropbox({clientId:this.clientId,clientSecret:this.clientSecret,accessToken:e})}async checkToken(e){console.log("%c Checking token","color: #f078c0"),console.log("removeSpinner",this.shared.removeSpinner);try{await e.usersGetCurrentAccount(),console.log("%c Access token is still valid","color: #7cb518"),alert("Access token is still valid ✔")}catch(e){console.log("removeSpinner",this.shared.removeSpinner),this.shared.removeSpinner&&(this.shared.routeList.innerHTML="Token Expired",this.shared.removeSpinner=!1);let t=confirm('Tokens only last 4 hour. This token might have expired ❌. Proceeding to "Auth" to get a new one.');console.log("%c Access token expired or is invalid","color: #f94144"),t&&(localStorage.setItem("access_token",null),this.auth2Flow())}}auth2Flow(){console.log("%c Auth2Flow","color: red"),history.replaceState({},document.title,window.location.href.split("#")[0]);const e="https://www.dropbox.com/oauth2/authorize?response_type=token&client_id="+this.clientId+"&redirect_uri="+encodeURIComponent(this.redirectUrl);window.location.href=e}}("gsw6a2m0r2u44lt","nwpi7lk0yyp2v44","https://hyperiondev.cogrammar.com/reviewer/dashboard/",e);console.log(t);let n,o=t.createDbxConnection();function a(){console.log("%c Extracting St Name","color: red");const e=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student:"))),t=e[0]?.textContent?.split(":")[1]?.trim();return t}async function l(n,a){let r=a;r.match(/build your brand/i)&&/(01|02|03|04|05)/.test(r)&&(r=function(e){const t={I:"01",II:"02",III:"03",IV:"04",V:"05",VI:"06"};return e.replace(/\b(I|II|III|IV|V|VI)\b/g,((e,n)=>t[n]||e))}(r).toLowerCase()),console.log("query",r),console.log(`%c Searching for files ${e.inc}`,"color: #5390d9");let s=n,c=e.inc;const d=e.inc>0?s+` (${c})`:s;await o.filesSearchV2({query:r,options:{path:"/"+d,max_results:5}}).then((function(t){e.removeSpinner&&(e.routeList.innerHTML="",e.removeSpinner=!1),console.log(`%c  making request: ${e.inc}`,"color: orange"),e.inc++;let o=t.result.matches;if(e.inc>=4)!function(t){document.querySelectorAll(".DBXFF-foundRes").forEach((n=>{let o=n.textContent?.toLowerCase()?.trim(),a=t.split(" ");e.taskNum.split(" ").forEach((e=>{if(e.length>0&&o.includes(e.toLowerCase())){let t=n.innerHTML.replace(new RegExp(e,"gi"),`<b style="font-weight: 100; color: #FFC107">${e}</b>`);n.innerHTML=t}})),a.forEach((e=>{if(e.length>2&&o.includes(e.toLowerCase())){let t=n.innerHTML.replace(new RegExp(e,"gi"),`<b class="highlight">${e}</b>`);n.innerHTML=t}}))}))}(r);else if(!e.foundFiles){if(console.log(`%c results found: ${o.length}`,"color: #2196f3"),o.forEach(((t,n)=>{let o=t.metadata.metadata.path_display;if(console.log("taskNum",e.taskNum),o.includes(e.taskNum)){e.taskNum<10&&(e.taskNum="T0"+e.taskNum[e.taskNum.length-1]);let n=document.createElement("div");n.className="DBXFF-btnAndListContainer";let o=document.createElement("div");o.className="DBXFF-foundRes",o.textContent=t.metadata.metadata.path_display;let a=document.createElement("div");a.className="DBXFF-dlIconContainer";let l=document.createElement("img"),r=document.createElement("img");r.title="Open Task Folder in dropbox",r.src=chrome.runtime.getURL("images/externalLink.png"),r.addEventListener("click",(async e=>{let n=t.metadata.metadata.path_display,o=n.lastIndexOf("/"),a="https://www.dropbox.com/work/HyperionDev%20Reviewers"+n.substring(0,o).replace(" ","%20");window.open(a,"_blank")})),document.createElement("img").alt=t.metadata.metadata.name,l.src=chrome.runtime.getURL("images/dlFOlder.png"),l.alt="dl-icon",l.className="DBXFF-dl-icon-list",l.title="Download Task folder",l.addEventListener("click",(async e=>{e.stopPropagation(),l.classList.add("rotate-center"),l.src=chrome.runtime.getURL("images/loader.png"),function(e,t){console.log("%c  creating Download Folder path","color: red");let n=!1;if(e.path_display.endsWith(".pdf")&&(n=!0),n){const n=e.path_display.lastIndexOf("/");i(e.path_display.substring(0,n),t)}else i(e.path_display,t)}(t.metadata.metadata,l)})),a.appendChild(l),n.appendChild(a),n.appendChild(r),n.appendChild(o),e.routeList.appendChild(n)}})),e.inc>=4)return;l(n,a)}})).catch((async function(n){console.log(n),e.removeSpinner&&(e.routeList.innerHTML="\n        <p>Either the token has expired. A popup will appear. (If not - Refresh Browser)</p>\n        <br>\n        <p>Or the Task Name could no be found inside student folders</p>\n        <br>\n        <p>Or CoGrammar API is offline</p>\n        <br>\n        <p>Or you have an internet connection issue</p>\n        <br>\n        <p>Try looking up the student number in Dropbox</p>\n        ",e.removeSpinner=!1),console.log("%c Search ended","color: hotpink"),await t.checkToken(o)}))}async function i(e,t){await o.filesDownloadZip({path:e}).then((function(t){!function(e,t){const n=window.URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=studentName+"_"+t,document.body.appendChild(o),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(new Blob([t.result.fileBlob],{type:"application/zip"}),e.substring(e.lastIndexOf("/")+1))})).catch((function(e){console.log(e),alert("Error downloading file. Download folder could be containing more than 100 files")})),t.classList.remove("rotate-center"),t.src=chrome.runtime.getURL("images/dlFOlder.png")}async function r(){if(window.location.pathname.includes("generate_review")){async function o(){"visible"===document.visibilityState?(clearInterval(n),n=setInterval((()=>s()),1e3),await r(),document.removeEventListener("visibilitychange",o)):clearInterval(n)}document.addEventListener("visibilitychange",o)}else clearInterval(n);e.counter=parseInt(localStorage.getItem("counter"))||0,e.min=parseInt(localStorage.getItem("minutes"))||0,e.lastSavedTime=parseInt(localStorage.getItem("lastSavedTime"))||(new Date).getTime(),e.counter+=Math.floor(((new Date).getTime()-e.lastSavedTime)/1e3),window.addEventListener("beforeunload",(async()=>{c(),clearInterval(n)}));let t=document.querySelectorAll("a");t?.forEach((t=>{t?.textContent.includes("Return to dashboard")&&t.addEventListener("click",(()=>{e.counter=0,e.min=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),localStorage.setItem("lastSavedTime",null),clearInterval(n),"false"==localStorage.getItem("rememberReview")&&(localStorage.setItem("id_improve_comments",""),localStorage.setItem("id_positive_comments",""),localStorage.setItem("id_overall_comments",""))}))}))}function s(){e.counter++,e.counter>59&&(e.min+=Math.floor(e.counter/60),e.counter%=60),e.min<5?(counterEl.style.color="#8BC34A",counterEl.style.animationDuration="10s"):e.min<7?(counterEl.style.color="#ffeb3b",counterEl.style.animationDuration="5s"):e.min<11?(counterEl.style.color="#ff9800",counterEl.style.animationDuration="2s"):e.min<13?(counterEl.style.color="#ff5722",counterEl.style.animationDuration="1s"):(e.min,counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s"),e.combinedTime=`${e.min>9?"":0}${e.min}:${e.counter>9?"":0}${e.counter}`,e.min>60&&(counterEl.style.color="#f44336",counterEl.style.animationDuration=".2s ",e.combinedTime="59:00",clearInterval(n)),counterEl.textContent=e.combinedTime,c()}function c(){localStorage.setItem("counter",e.counter),localStorage.setItem("minutes",e.min),localStorage.setItem("lastSavedTime",(new Date).getTime())}(window.location.pathname.includes("generate_review")||window.location.pathname.includes("generate_dfe_review"))&&(function(){console.log("%c Creating UI","color: red"),document.createElement("span").className="result_loader",e.routeList=document.createElement("div"),e.routeList.className="DBXFF-query-results",e.routeList.innerHTML='<span class="result_loader"></span>';const t=document.createElement("div");t.className="DBXFF-main-input-container",floatingElement.className="DBXFF-box-layout DBXFF-slide-in-left",floatingElement.style.backgroundImage=`url(${chrome.runtime.getURL("./images/nav-bg.gif")})`;let n=document.createElement("div");n.className="DBXFF-slide-btn ",n.textContent="Hide";let o=!1;n.addEventListener("click",(()=>{floatingElement.classList.toggle("DBXFF-slide-out-left"),n.classList.toggle("toggleBtn"),o=!o,o?(n.textContent="Show",timerContainer.classList.add("DBXFF-timer-container-fixed","fade-in")):(n.textContent="Hide",timerContainer.classList.remove("DBXFF-timer-container-fixed","fade-in"))})),studentNumberEl.id="DBXFF-mystudentNumberEl",taskNameEl.id="DBXFF-mytaskNameEl",floatingElement.prepend(n),studentNameEl.textContent=a(),reviewDetailsEl.appendChild(studentNameEl),studentNumberContainerEl.appendChild(lookUpStudentBtn),studentNumberContainerEl.appendChild(studentNumberEl),reviewDetailsEl.appendChild(studentNumberContainerEl),reviewDetailsEl.appendChild(taskNameEl),t.appendChild(reviewDetailsEl),t.appendChild(e.routeList),floatingElement.appendChild(t),document.body.appendChild(floatingElement),function(){console.log("%c Extracting St Number","color: red");const t=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Student number"))),n=t[0]?.textContent?.split(":")[1]?.trim();studentNumberEl.textContent=n,function(t){e.sharedStudentNum=t,lookUpStudentBtn.addEventListener("click",(()=>{let e=`https://www.dropbox.com/search/work?path=%2F&query=${t}&search_token=mUrM54J2SiALJes%2B%2Boc65k3O8pz4DOlJOX9WlhH8KKI%3D&typeahead_session_id=09702658948404806500012995044766`;window.open(e,"_blank")})),console.log("%c Extracting Task Name","color: red");let n=[...document.querySelectorAll("h6")].filter((e=>e.textContent.includes("Task")));n.forEach((t=>{let n=/Task \d+/gi;n.test(t.textContent)&&(e.taskNum=t.textContent.match(n)[0].split(" ")[1],console.log(e.taskNum),localStorage.setItem("taskNumber",`Task ${e.taskNum}`))})),n.forEach((n=>{const o=n?.textContent?.trim(),a=o.lastIndexOf("-")+1;if(0!==a&&(e.foundTaskName=o?.substring(a)?.trim(),e.foundTaskName.includes(":"))){const t=e.foundTaskName.lastIndexOf(":")+1;e.foundTaskName=e.foundTaskName?.substring(t)?.trim()}taskNameEl.textContent=e.foundTaskName,e.removeSpinner=!0,l(t,e.foundTaskName,e.taskNum)}))}(n),a()}(),function(){let t=localStorage.getItem("reviewCount");e.reviewCount=t||0;let n=document.createElement("div");n.className="DBXFF-counter-container";let o=document.createElement("p");o.className="DBXFF-review-count",o.textContent=`Reviews done: ${e.reviewCount}`;let a=document.createElement("img");a.src=chrome.runtime.getURL("images/reset.png"),a.alt="reviewReset",a.title="Reset",a.addEventListener("click",(()=>{confirm("Are you sure you want to reset the review count?")&&(e.reviewCount=0,localStorage.setItem("reviewCount",0),o.textContent="Reviews done: 0")})),n.prepend(a),n.prepend(o),floatingElement.prepend(n)}()}(),r(),n=setInterval((()=>s()),1e3)),timeResetIcon.addEventListener("click",(async()=>{console.log("%c timer reset","color: #ffba08"),clearInterval(n),e.counter=0,e.min=0,localStorage.setItem("minutes",null),localStorage.setItem("counter",null),e.combinedTime=0,n=setInterval((()=>s()),1e3),await r()})),reviewCompleteBtn?.addEventListener("click",(()=>{e.reviewCount++,localStorage.setItem("reviewCount",e.reviewCount),counterEl.style.color="#8BC34A",counterEl.style.animationDuration="3s"}))})();